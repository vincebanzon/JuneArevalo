!function(t,e){"function"==typeof define&&define.amd?define(e):t.BackgroundCheck=e(t)}(this,function(){"use strict";function t(t){if(void 0===t||void 0===t.targets)throw"Missing attributes";P.debug=o(t.debug,!1),P.debugOverlay=o(t.debugOverlay,!1),P.targets=l(t.targets),P.images=l(t.images||"img, div, body",!0),P.changeParent=o(t.changeParent,!1),P.threshold=o(t.threshold,50),P.minComplexity=o(t.minComplexity,30),P.minOverlap=o(t.minOverlap,50),P.windowEvents=o(t.windowEvents,!0),P.maxDuration=o(t.maxDuration,500),P.callback=o(t.callback,function(){}),P.mask=o(t.mask,{r:0,g:255,b:0}),P.classes=o(t.classes,{dark:"background--dark",light:"background--light",complex:"background--complex"}),void 0===N&&(g(),N&&(I.style.position="fixed",I.style.top="0px",I.style.left="0px",I.style.width="100%",I.style.height="100%",E=W.bind(null,function(){c(),T()}),window.addEventListener(O,E),L=W.bind(null,T),window.addEventListener("scroll",L),c(),T()))}function e(){w(),N&&(window.removeEventListener(O,E),window.removeEventListener("scroll",L),E=null,L=null),N=null,I=null,R=null,P={},D&&clearTimeout(D)}function i(t){S("debug")&&console.log(t)}function o(t,e){return n(t,typeof e),void 0===t?e:t}function n(t,e){if(void 0!==t&&typeof t!==e)throw"Incorrect attribute type"}function a(t){if("file:"===location.protocol)return!0;var e=document.createElement("a");return e.href=t,location.protocol!==e.protocol||location.hostname!==e.hostname}function r(t){for(var e,o,n,r=[],l=0;l<t.length;l++)if(e=t[l],r.push(e),"IMG"===e.tagName){if(a(e.src)){r[l]=!1;continue}}else{if(o=window.getComputedStyle(e).backgroundImage,n=window.getComputedStyle(e).backgroundColor,o.split(/,url|, url/).length>1)continue;if(o&&"none"!==o){if(o=o.slice(4,-1),o=o.replace(/"/g,""),a(o))continue;r[l]={img:new Image,el:r[l]},r[l].img.src=o,i("CSS Image - "+o)}else if("CANVAS"===e.tagName){var g=new Image(e.width,e.height);g.src=e.toDataURL("image/jpeg"),g.el=e,r[l]=g}else n&&"none"!==n&&"rgba(0, 0, 0, 0)"!==n&&"transparent"!==n&&(r[l]={el:r[l],color:n},i("CSS Color - "+n))}return r}function l(t,e){var i=t;if("string"==typeof t?i=document.querySelectorAll(t):t&&1===t.nodeType&&(i=[t]),!i||0===i.length||void 0===i.length)throw"Elements not found";return e&&(i=r(i)),i=Array.prototype.slice.call(i)}function g(){I=document.createElement("canvas"),I&&I.getContext?(R=I.getContext("2d"),N=!0):N=!1,d()}function d(){S("debugOverlay")?(I.style.opacity=.5,I.style.pointerEvents="none",document.body.appendChild(I)):I.parentNode&&I.parentNode.removeChild(I)}function h(t){var o=(new Date).getTime()-t;i("Duration: "+o+"ms"),o>S("maxDuration")&&(console.log("BackgroundCheck - Killed"),w(),e())}function c(){B={left:0,top:0,right:document.body.clientWidth,bottom:window.innerHeight},I.width=document.body.clientWidth,I.height=window.innerHeight}function u(t,e,i){var o,n;return-1!==t.indexOf("px")?o=parseFloat(t):-1!==t.indexOf("%")?(o=parseFloat(t),n=o/100,o=n*e,i&&(o-=i*n)):o=e,o}function m(t){var e=window.getComputedStyle(t.el);t.el.style.backgroundRepeat="no-repeat",t.el.style.backgroundOrigin="padding-box";var i=e.backgroundSize.split(" "),o=i[0],n=void 0===i[1]?"auto":i[1],a=t.el.clientWidth/t.el.clientHeight,r=t.img.naturalWidth/t.img.naturalHeight;"cover"===o?a>=r?(o="100%",n="auto"):(o="auto",i[0]="auto",n="100%"):"contain"===o&&(1/r>1/a?(o="auto",i[0]="auto",n="100%"):(o="100%",n="auto")),o="auto"===o?t.img.naturalWidth:u(o,t.el.clientWidth),n="auto"===n?o/t.img.naturalWidth*t.img.naturalHeight:u(n,t.el.clientHeight),"auto"===i[0]&&"auto"!==i[1]&&(o=n/t.img.naturalHeight*t.img.naturalWidth);var l=e.backgroundPosition;"top"===l?l="50% 0%":"left"===l?l="0% 50%":"right"===l?l="100% 50%":"bottom"===l?l="50% 100%":"center"===l&&(l="50% 50%"),l=l.split(" ");var g,d;return 4===l.length?(g=l[1],d=l[3]):(g=l[0],d=l[1]),d=d||"50%",g=u(g,t.el.clientWidth,o),d=u(d,t.el.clientHeight,n),4===l.length&&("right"===l[0]&&(g=t.el.clientWidth-t.img.naturalWidth-g),"bottom"===l[2]&&(d=t.el.clientHeight-t.img.naturalHeight-d)),g+=t.el.getBoundingClientRect().left,d+=t.el.getBoundingClientRect().top,{left:Math.floor(g),right:Math.floor(g+o),top:Math.floor(d),bottom:Math.floor(d+n),width:Math.floor(o),height:Math.floor(n)}}function s(t){var e,i,o;if(t.nodeType||t.color&&t.el){t=t.el||t;var n=t.getBoundingClientRect();e={left:n.left,right:n.right,top:n.top,bottom:n.bottom,width:n.width,height:n.height},o=t.parentNode,i=t}else e=m(t),o=t.el,i=t.img;o=o.getBoundingClientRect(),e.imageTop=0,e.imageLeft=0,e.imageWidth=i.naturalWidth,e.imageHeight=i.naturalHeight;var a,r=e.imageHeight/e.height;return e.top<o.top&&(a=o.top-e.top,e.imageTop=r*a,e.imageHeight-=r*a,e.top+=a,e.height-=a),e.left<o.left&&(a=o.left-e.left,e.imageLeft+=r*a,e.imageWidth-=r*a,e.width-=a,e.left+=a),e.bottom>o.bottom&&(a=e.bottom-o.bottom,e.imageHeight-=r*a,e.height-=a),e.right>o.right&&(a=e.right-o.right,e.imageWidth-=r*a,e.width-=a),e.imageTop=Math.floor(e.imageTop),e.imageLeft=Math.floor(e.imageLeft),e.imageHeight=Math.floor(e.imageHeight),e.imageWidth=Math.floor(e.imageWidth),e}function f(t){var e=s(t);t=t.nodeType?t:t.img,e.imageWidth>0&&e.imageHeight>0&&e.width>0&&e.height>0?(i("Drawing: "+t.src),R.drawImage(t,e.imageLeft,e.imageTop,e.imageWidth,e.imageHeight,e.left,e.top,e.width,e.height)):i("Skipping image - "+t.src+" - area too small")}function p(t,e){var o=s(t);t=t.nodeType?t:t.img,o.width>0&&o.height>0?(i("Fill: "+e),R.beginPath(),R.rect(o.left,o.top,o.width,o.height),R.fillStyle=e,R.fill()):i("Skipping color - "+e+" - area too small")}function v(t,e,i){var o=t.className;switch(i){case"add":o+=" "+e;break;case"remove":var n=new RegExp("(?:^|\\s)"+e+"(?!\\S)","g");o=o.replace(n,"")}t.className=o.trim()}function w(t){for(var e,i=t?[t]:S("targets"),o=0;o<i.length;o++)e=i[o],e=S("changeParent")?e.parentNode:e,v(e,S("classes").light,"remove"),v(e,S("classes").dark,"remove"),v(e,S("classes").complex,"remove")}function y(t){var e,o,n,a,r=t.getBoundingClientRect(),l=0,g=0,d=0,h=0,c=S("mask"),u=!1;if(r.width>0&&r.height>0){w(t),t=S("changeParent")?t.parentNode:t,o=R.getImageData(r.left,r.top,r.width,r.height).data;for(var m=0;m<o.length;m+=4)o[m]===c.r&&o[m+1]===c.g&&o[m+2]===c.b?h++:(l++,e=.2126*o[m]+.7152*o[m+1]+.0722*o[m+2],n=e-d,g+=n*n,d+=n/l);if(h<=o.length/4*(1-S("minOverlap")/100)){a=Math.sqrt(g/l)/255,d/=255;var s=d<=S("threshold")/100?"dark":"light";i("Target: "+t.className+" lum: "+d+" var: "+a),v(t,S("classes")[s],"add"),a>S("minComplexity")/100&&(u=!0,v(t,S("classes").complex,"add")),P.callback(t,s,u)}}}function b(t,e){return t=(t.nodeType?t:t.el).getBoundingClientRect(),e=e===B?e:(e.nodeType?e:e.el).getBoundingClientRect(),!(t.right<e.left||t.left>e.right||t.top>e.bottom||t.bottom<e.top)}function k(t){for(var e,i=(new Date).getTime(),o=t&&("IMG"===t.tagName||t.img)?"image":"targets",n=!t,a=S("targets").length,r=0;a>r;r++)e=S("targets")[r],b(e,B)&&("targets"!==o||t&&t!==e?"image"===o&&b(e,t)&&y(e):(n=!0,y(e)));if("targets"===o&&!n)throw t+" is not a target";h(i)}function C(t){var e=function(t){var e=0;return"static"!==window.getComputedStyle(t).position&&(e=parseInt(window.getComputedStyle(t).zIndex,10)||0,e>=0&&e++),e},i=(t.parentNode,e(t));return i}function x(t){var e=!1;return t.sort(function(t,i){if(!t||!i)return 0;t=t.nodeType?t:t.el,i=i.nodeType?i:i.el;var o=t.compareDocumentPosition(i),n=0;return t=C(t),i=C(i),t>i&&(e=!0),t===i&&2===o?n=1:t===i&&4===o&&(n=-1),n||t-i}),i("Sorted: "+e),e&&i(t),e}function T(t,e,o){if(N){var n=S("mask");i("--- BackgroundCheck ---"),i("onLoad event: "+(o&&o.src)),e!==!0&&(R.clearRect(0,0,I.width,I.height),R.fillStyle="rgb("+n.r+", "+n.g+", "+n.b+")",R.fillRect(0,0,I.width,I.height));for(var a,r,l=o?[o]:S("images"),g=x(l),d=!1,h=0;h<l.length;h++)a=l[h],r=a.nodeType&&"IMG"===a.tagName?a:a.img,(r||a.color)&&b(a,B)&&(a.color?p(a.el,a.color):0===r.naturalWidth?(d=!0,i("Loading... "+a.src),r.removeEventListener("load",T),g?r.addEventListener("load",T.bind(null,null,!1,null)):r.addEventListener("load",T.bind(null,t,!0,a))):f(a));o||d?o&&k(o):k(t)}}function W(t){S("windowEvents")===!0&&(D&&clearTimeout(D),D=setTimeout(t,200))}function H(t,e){if(void 0===P[t])throw"Unknown property - "+t;if(void 0===e)throw"Missing value for "+t;if("targets"===t||"images"===t)try{e=l("images"!==t||e?e:"img, div, body","images"===t)}catch(i){throw e=[],i}else n(e,typeof P[t]);w(),P[t]=e,T(),"debugOverlay"===t&&d()}function S(t){if(void 0===P[t])throw"Unknown property - "+t;return P[t]}function M(){for(var t,e=S("images"),i=[],o=0;o<e.length;o++)t=s(e[o]),i.push(t);return i}var E,L,N,I,R,D,B,O=void 0!==window.orientation?"orientationchange":"resize",P={};return{init:t,destroy:e,refresh:T,set:H,get:S,getImageData:M}});